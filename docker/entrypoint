#!/bin/bash

# Default variables
KEEPALIVED_INTERFACE=${KEEPALIVED_INTERFACE:-eth0}
KEEPALIVED_VIRTUAL_ROUTER_ID=${KEEPALIVED_VIRTUAL_ROUTER_ID:-51}
KEEPALIVED_PRIORITY=${KEEPALIVED_PRIORITY:-100}
KEEPALIVED_AUTH_PASS=${KEEPALIVED_AUTH_PASS:-ETlE2RQr}

# required variables
# KEEPALIVED_UNICAST_SRC_IP
# KEEPALIVED_UNICAST_PEER
# KEEPALIVED_VIRTUAL_IPADDRESS

KEEPALIVED_CONF=/etc/keepalived/keepalived.conf

sed -i "s!{{KEEPALIVED_INTERFACE}}!${KEEPALIVED_INTERFACE}!g" ${KEEPALIVED_CONF}
sed -i "s!{{KEEPALIVED_VIRTUAL_ROUTER_ID}}!${KEEPALIVED_VIRTUAL_ROUTER_ID}!g" ${KEEPALIVED_CONF}
sed -i "s!{{KEEPALIVED_PRIORITY}}!${KEEPALIVED_PRIORITY}!g" ${KEEPALIVED_CONF}
sed -i "s!{{KEEPALIVED_UNICAST_SRC_IP}}!${KEEPALIVED_UNICAST_SRC_IP}!g" ${KEEPALIVED_CONF}

UNICAST_PEER=$(echo $KEEPALIVED_UNICAST_PEER | sed "s/\s//g" | sed "s/,/ /g")
for up in ${UNICAST_PEER[@]}; do
  sed -i "s!{{KEEPALIVED_UNICAST_PEER}}!${up}\n    {{KEEPALIVED_UNICAST_PEER}}!" ${KEEPALIVED_CONF}
done
  sed -i "/{{KEEPALIVED_UNICAST_PEER}}/d" ${KEEPALIVED_CONF}

VIPs=$(echo $KEEPALIVED_VIRTUAL_IPADDRESS | sed "s/\s//g" | sed "s/,/ /g")
for vip in ${VIPs[@]}; do
  sed -i "s!{{KEEPALIVED_VIRTUAL_IPADDRESS}}!${vip} dev ${KEEPALIVED_INTERFACE} label ${KEEPALIVED_INTERFACE}:0\n    {{KEEPALIVED_VIRTUAL_IPADDRESS}}!" ${KEEPALIVED_CONF}
done
  sed -i "/{{KEEPALIVED_VIRTUAL_IPADDRESS}}/d" ${KEEPALIVED_CONF}

sed -i "s!{{KEEPALIVED_AUTH_PASS}}!${KEEPALIVED_AUTH_PASS}!g" ${KEEPALIVED_CONF}

exec "$@"
